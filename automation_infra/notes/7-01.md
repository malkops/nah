## Ansible

### IAC
**Инфраструктура как код** - это подход к управлению и описанию инфраструктуры через конфигурационные файлы, а не через ручное редактирование конфигураций на серверах.

Плюсы IAC:
 - Нет необходимости в ручной настройке;
 - Скорость: настройка/поднятие инфраструктуры занимает на порядок меньше времени;
 - Воспроизводимость: поднимаемая инфраструктура всегда идентична;
 - Масштабируемость: один инженер может с помощью одного и того же кода настраивать и управлять большим парком машин.

### Configuration management systems

**Системы управления конфигурациями** - программы и комплексы, позволяющие централизованно управлять конфигурацией множества разнообразных разрозненных ОС и прикладного ПО, работающего в них. При работе с системами управления конфигурациями говорят об автоматизации инфраструктуры или об оркестрации серверов.

Преимущества Configuration management system:
 - Использовать систему контроля версий для отслеживания любых изменений инфраструктуры;
 - Повторно использовать скрипты конфигурирования для нескольких серверных сред (разработка, тестирование, прод);
 - Предоставлять сотрудникам общий доступ к скриптам конфигурирования для упрощения сотрудничества в стандартной среде разработки;
 - Упрощать процесс дублирования серверов для ускорения восстановления в случае сбоя системы.

Примеры инструментов управления кофигурацией:
 - **Chef** - DSL, Ruby, клиент-сервер;
 - **Puppet** - DSL (JSON), Ruby, клиент-сервер;
 - **SaltStack** - YAML, Python, клиент-сервер, безагентный;
 - **Ansible** - YAML, Python, безагентный.

### Ansible

**Ansible** - система управления конфигурациями, Позволяет централизованно управлять ПО, ОС и их настройками на Linux, Mac, Windows. Написан на Python, открытый исходный код, разработчик - Red Hat. Ansible отправляет команды на удаленные хосты через ssh.

Особенности Ansible:
 - **Безагентный** - для работы (настройки) с управляемым узлом нет необходимости ставить на управляемый узел агента. Необходимых требований только два: работающий ssh-сервер, python >= 2.6.
 - **Идемпотентность** - независимо от того, сколько раз вы будете запускать playbook, результат всегда должно приводить к одном и тому же состоянию.
 - **Push-model** - изменения конфигураций "заталкиваются" на управляемые узлы. Это может быть и минусом.

Терминология:
 - **Узел управления** - устройство с установленным и настроенным Ansible. Может быть ваш ноутбук или специальный узел в сети, выделенный для задач управления.
 - **Управляемые узлы** - узлы, конфигурация которых выполняется.
 - **Файлы инвентаризации (inventory)** - файл(ы), в которых перечислены управляемые узлы: *.ini, *.yaml или динамический конфигурируемым. Другими словами, это файл, в котором описываются устройства, к которым будет подключаться и управлять Ansible. Две группы по умолчанию (all и ungrouped).
 - **Модули (modules)** - инструментарий Ansible, отвечают за действия, которые выполняет Ansible. Это небольшие программы, входящие в поставку, принимающие на вход значения и выполняющие работу на целевых хостах. Фактически вся работа происходит с использованием модулей.
 - **Задачи (tasks)** - отдельный элемент работы, которую нужно выполнить. Могут выполняться самостоятельно или в составе плейбук.
 - **Плейбук (playbook)** - состоит из списка задач и/или других директив, указывающих на то, какие действия и где будут производиться.
 - **Обработчики (handlers)** - элемент, который служит для экономии кода и сособен перезапускать службу при его вызове.
 - **Роли (roles)** - набор плейбуков и других файлов, которые предназначены для выполнения какой-либо конечной задачи. Также упрощают, сокращают код и делают его переносимым.

Ansible.cfg - это основной конфигурационный файл. Может храниться:
 - ANSIBLE_CONFIG (ппеременная окрежения);
 - ansible.cfg (в текущем каталоге);
 - ~/.ansible.cfg (в домашнем каталоге пользователя);
 - /etc/ansible/ansible.cfg (можно брать за образец для внесения правок).

 - Упрощать процесс дублирования серверов для ускорения восстановления в случае сбоя системы.

Примеры инструментов управления кофигурацией:
 - **Chef** - DSL, Ruby, клиент-сервер;
 - **Puppet** - DSL (JSON), Ruby, клиент-сервер;
 - **SaltStack** - YAML, Python, клиент-сервер, безагентный;
 - **Ansible** - YAML, Python, безагентный.

### Playbook

**Playbook** - это основной рабочий скрипт, он позволяет объединять задачи (task), роли в одном файле и передавать их для выполнения на определенные группы хостов.
Преимущества playbook'ов:
 - запуск множество задач для множества хостов;
 - управление запусками и сокращение кода.

```bash
# пример запуска
ansible-playbook my-playbook.yaml
# пример проверки синтаксиса плейбука
ansible-playbook my-playbook.yaml --syntax-check
```

При создании ВМ с помощью Vagrant может понадобиться производить донастройку ВМ. Vagrant позволяет делать это с помощью _provision_. Можно использовать shell или ansible.
Пример

```ruby
Vagrant.configure("2") do |config|

  config.vm.provision "ansible" do |ansible|
    ansible.playbook = "playbook.yml"
  end

end
```

### Role

**Role** - это набор файлов, задач, шаблонов, переменных и обработчиков, которые объеденены вместе в логическую структуру и служат определенной цели.

Например, настройка сервера времени. Роли можно подключать в плейбуки. Роли удобно передавать коллегам как целостную сущность.

Преимущества использования ролей:
 - можно использовать для нескольких проектов;
 - удобно передавать;
 - удобно отправить на внешние ресурсы;
 - удобно управлять зависимостями.

Расположение ролей на файловой системе:
 - **./roles** - самый высокий приоритет
 - **~/.ansible/roles**
 - **/etc/ansible/roles**
 - **/usr/share/ansible/roles** - самый низкий приоритет

Структура ролей:
 - **defaults**: содержит переменные по умолчанию для роли, которые должны быть легко перезаписан;
 - **vars**: содержит стандартные переменные для роли, которые не должны быть перезаписаны в вашей книге;
 - **task**: содержит набор задач;
 - **handlers**: содержит набор обработчиков;
 - **templates**: содержит шаблоны Jinja2;
 - **files**: содержит статические файлы, необходимые для ролевых задач;
 - **tests**: содержит дополнительный файл инвентаря, а также playbook test.yml, который можно использовать для тестирования роли;
 - **meta**: содержит метаданные роли, такие как информация об авторе, лицензия, зависимости и т.д.

Для того чтобы запустить роль, необходимо написать playbook и в нем вызвать роль. При необходимости можно переопределить переменные в момент вызова роли.
Для интерактивной работы с ролями используется команда `ansible-galaxy`.

**Ansible-galaxy** - это [сайт](https://galaxy.ansible.com/home), который является публичным репозиторием для ansible-ролей, написанных сообществом.
Примеры на команд:

```bash
ansible-galaxy role list
ansible-galaxy role init myrole
ansible-galaxy role search nginx
ansible-galaxy role install nginx
ansible-galaxy role remove nginx
```


**Tags** служат для того, чтобы помечать определенные задачи (task) внутри плейбука или роли и вызывать (или наоборот пропускать) только их, не заставляя выполняться весь плейбук:
```bash
ansible-playbook -i host.ini --tags prod playbook.yml
ansible-playbook -i host.ini --skip-tags prod playbook.yml
```

**Handlers** - это специальные задачи. Они вызываются из других задач ключевым словом _notify_. Служат для сокращения кода.
За счет конструкции **when** можно выполнять задачу из плейбука только при выполнении какого-либо условия.
С помощью механизма Jinja2 можно динамически создавать конфигурационные файлы. Для работы с шаблонами Jinja2 используется модуль template.

Чтобы не хранить пароли в открытом виде в Ansible, существует vault - шифрованное хранилище паролей.
**Ansible-vault** - утилита, которая позволяет работать с таким хранилищем.
Пример команд для работы с ansible-vault:

```bash
ansible-vault create file2.yml
ansible-vault decrypt file2.yml
ansible-vault encrypt file2.yml
anisble-vault rekey file2.yml
```

**Ansible tower** - графический веб-интерфейс для управления и мониторинга работы Ansible.
Позволяет:
 - пользователям работать со скриптами без необходимости настраивать окружение и разбираться с ним;
 - управлять доступом и создавать группы для определенных категорий пользователей (есть интеграция с LDAP);
 - настраивать разного рода автоматизации при помощи REST API.

**Molecule** - это фреймворк для тестирования Ansible ролей. В конфигурационных файлах Molecule описывается инфраструктура и тесты, которыми покрывается роль.
