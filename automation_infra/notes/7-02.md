## Terraform

### Недостатки IaC

- Разработка IaC может потребовать использования дополнительных утилит, а любые ошибки при таком проектировании могут быть быстро распространены по всем окружениям проекта, поэтому IaC должен быть всесторонне протестирован.
- Конфигурация окружения была изменена администратором, без внесения сотвутствующих изменений в IaC, поэтому особенно важно полностью интегрировать IaC в процесс системного администрирования, во все IT и DevOps процессы и вести документацию.
- В большинстве случаев IaC - это какой-то DSL. А DSL - это описание структуры. В них может не быть таких привычных вещей как переменные, условия, комментарии, функции и т.д.

### Terraform

**[Terraform](https://www.terraform.io/)** - это программный инструмент с открытым исходным кодом, созданный HashiCorp, который помогает управлять облачной инфраструктурой. Пользователи определяют и предоставляют инфраструктуру ЦОДа с помощью декларативного языка конфигурации HCL или JSON.

В Terraform используется HCL. **HCL** - это язык программирования, разработанный HashiCorp. Представляет собой методологию разработки, предназначенную для ускорения процесса кодирования. HCL используется для настройки программных сред и программных библиотек. HCL совместим с JSON благодаря API HCL, его дизайн и [синтаксис](https://terraform.io/docs/language) более читабельный.

#### Особенности Terraform
- Орекстрирование, а не просто конфигурация инфраструктуры;
- Построение неизменяемой инфраструктуры;
- Декларативный, а не процедурный код;
- Архитектура, работающая на стороне клиента.

**Оркестрирование** - автоматизированный процесс управления связанными сущностями, такими как группы виртуальных машин или контейнеров.

Terraform сконцентрирован на задачах по созданию серверов с нуля, оставляя работу по размещению контейнеров с помощью ПО, платформам типа Docker или Packer. Когда вся инфраструктура вашей облачной экосистемы работает как код, и все параметры записаны в декларативные файлы конфигурации, специалисты вашей команды могут работать с ними и изменять эти файлы, как и любой другой код.

#### Неизменяемая vs одноразовая
Основное отличие состоит в том, что **неизменяемая** инфраструктура привязана к железу, программе, компонентам в ней, а если нам что-то надо изменить, то мы каждый раз создаем новую инфраструктуру. **Одноразовость** заключается в том, что если инфраструктура стала не нужна, то ее можно просто удалить.

#### Неизменяемая инфраструктура
Terraform работает по концепции неизменяемой инфраструктуры, где каждое изменений какого-либо компонента, приводит к созданию отдельного состояния инфраструктуры, то есть к построению новой системы и удалению предыдущей кофигурации. Это означает, что процесс обновения ПО идет легко и бытро по всей системе сразу и защищен от возможных ошибок.

#### Декларативный код
При помощи Terraform, мы просто указываем утилите, какие изменения нужно произвести с текущим состоянием системы, что позволяет обходиться довольно компактной и очень простой библиотекой шаблонов кода.
При использовании Chef или Ansible вы вынуждены писать пошаговые процедурные инструкции, по достижению требуемого состояния системы. Напротив, Terraform, Salt или Puppet предпочитают описывать конечные состояния системы, оставляя конфигурацию на усмотрение утилиты.

#### Работает на стороне клиента
Terraform использует API, предоставляемые поставщиком облачного хостинга. С их помощью утилита строит инфраструктуру, что означает: уход от излишних проверок безопасности, остутствие необходимости в работе отдельного сервера для управления конфигурациями и выделение ресурсов на работу многочисленных программ-агентов.

### Недостатки Terraform
- Как дирижерскую палочку может использовать только один дирижер, так и Terraform желательно использовать одному оператору или хотя бы с одного терминала.
- Утилита была разработана только под облако и непригодна для использования с кластерами выделенных серверов.

### Преимущества Terraform
- Портативность - **одна утилита и один язык** применяется для описания облачной инфраструктуры в Google Cloud, AWS, OpenStack и работы с любым другим поставщиком услуг. Смена поставщика облачного хостинга больше не является проблемой.
- Простота полноценного запуска приложений. Предположим, на ваших серверах Amazon запущены Docker контейнеры по управлением k8s, в которых работает широкий спект приложений, и всё это с легкостью управляется с помощью одного инструмента.

Terraform использует конфигурационные файлы с расширением **.tf**.
Минимальный набор переменных для успешного подключения:
```
provider "provider name" {
  user     = "login"
  password = "pwd"
  org      = "org_name"
  url      = "API_site"
}
```

### Синтаксис Terraform

- Однострочные комментарии - **#**
- Многострочные комментарии - **/\* \*/**
- Значения присваиваются - **key = value**
- Строки в двойных кавычках - **""**
- Интерполяция в строках - **${}**
- Числа имеют основание 10, но если перед числом поставить **0x**, то оно будет равно 16
- Многострочные конструкции могут использовать синтаксис "здесь, документ" в стиле оболочки, т.е. строка начинается с маркера **<<EOF**, а заканчивается **EOF** в отдельной строке**
- Логические значения - **true**, **false**
- Списки примитивных типов - **[]**
- **Map**'ы создаются с помощью двоеточие (**:**) и **{}** - **{foo: "bar", "bar": "baz"}**. Кавычки в ключах могут остутствовать, если ключ не начинается с числа. Для однострочных представлений необходимы запятые между парами ключ/значение. В многострочных достаточно новой строки.

**Условный строчный оператор**: `CONDITION ? TRUE : FALSE`
Пример:
```
resource "aws_instance" "web" {
  subnet = "${var.env == "production" ? var.prod_subnet : var.dev_subnet}"
}
```
**Подерживаемые операторы**:
Равенство: **==** и **!=**, численное сравнение: **>**, **<**, **>=**, **<=**, логическая логика: **&&**, **||**, **!**.